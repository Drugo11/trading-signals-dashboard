<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Trading Signals Visualizer</title>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        margin: 20px;
        color: #333;
      }
      h1 {
        font-size: 24px;
      }
      label {
        font-weight: bold;
        margin-right: 10px;
      }
      select {
        padding: 5px;
        font-size: 14px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 15px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f9f9f9;
        font-weight: bold;
      }
      tr:nth-child(even) {
        background-color: #f5f5f5;
      }
      .long {
        color: green;
        font-weight: bold;
      }
      .short {
        color: red;
        font-weight: bold;
      }
      .flat {
        color: #666;
      }
      canvas {
        margin-top: 25px;
        max-width: 100%;
      }
    </style>
  </head>
  <body>
    <h1>Trading Signals Visualizer</h1>
    <p>Use this page to explore daily signals generated by the machineâ€‘learning model. Select a date from the dropdown to view the corresponding long/short classifications and predicted returns for each ticker. The bar chart below the table provides a visual summary of the predictions.</p>
    <label for="date-select">Select date:</label>
    <select id="date-select"></select>
    <table id="signals-table">
      <thead>
        <tr>
          <th>Ticker</th>
          <th>Prediction</th>
          <th>Signal</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <canvas id="chart" width="800" height="400"></canvas>
    <!-- Load Chart.js from CDN.  If you prefer a local copy, download the script and serve it locally. -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Load precomputed signals data.  This script defines a global variable `signalsData`. -->
    <script src="signals.js"></script>
    <script>
      // If signalsData is already defined via signals.js, use it directly; otherwise attempt to fetch from signals.json.
      let loadedSignals = Array.isArray(typeof signalsData !== 'undefined' ? signalsData : [])
        ? signalsData
        : [];

      async function fetchSignals() {
        // If signals are preloaded, skip fetching
        if (loadedSignals.length > 0) {
          populateDates();
          return;
        }
        try {
          const response = await fetch('signals.json');
          loadedSignals = await response.json();
        } catch (error) {
          console.error('Failed to load signals.json', error);
          loadedSignals = [];
        }
        populateDates();
      }

      function populateDates() {
        const dateSelect = document.getElementById('date-select');
        // Remove any existing options
        dateSelect.innerHTML = '';
        // Extract unique dates and sort them chronologically
        const dates = Array.from(new Set(loadedSignals.map((s) => s.date))).sort();
        dates.forEach((date) => {
          const opt = document.createElement('option');
          opt.value = date;
          opt.textContent = date;
          dateSelect.appendChild(opt);
        });
        dateSelect.addEventListener('change', updateTable);
        // If there are dates available, default to the most recent
        if (dates.length > 0) {
          dateSelect.value = dates[dates.length - 1];
          updateTable();
        }
      }

      function updateTable() {
        const selectedDate = document.getElementById('date-select').value;
        const tbody = document.getElementById('signals-table').querySelector('tbody');
        tbody.innerHTML = '';
        // Filter signals for the selected date and sort by prediction descending
        const rows = loadedSignals
          .filter((s) => s.date === selectedDate)
          .sort((a, b) => b.prediction - a.prediction);
        rows.forEach((row) => {
          const tr = document.createElement('tr');
          let cls = 'flat';
          if (row.signal === 1) cls = 'long';
          else if (row.signal === -1) cls = 'short';
          tr.innerHTML = `<td>${row.ticker}</td><td>${row.prediction.toFixed(4)}</td><td class="${cls}">${cls.toUpperCase()}</td>`;
          tbody.appendChild(tr);
        });
        updateChart(rows);
      }

      let chart;
      function updateChart(rows) {
        const ctx = document.getElementById('chart').getContext('2d');
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: rows.map((r) => r.ticker),
            datasets: [
              {
                label: 'Predicted return',
                data: rows.map((r) => r.prediction),
                backgroundColor: rows.map((r) => {
                  if (r.signal === 1) return 'rgba(0, 128, 0, 0.5)';
                  if (r.signal === -1) return 'rgba(255, 0, 0, 0.5)';
                  return 'rgba(128, 128, 128, 0.5)';
                }),
                borderColor: rows.map((r) => {
                  if (r.signal === 1) return 'rgba(0, 128, 0, 1)';
                  if (r.signal === -1) return 'rgba(255, 0, 0, 1)';
                  return 'rgba(128, 128, 128, 1)';
                }),
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
              title: {
                display: true,
                text: 'Predicted returns and signal classification',
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Predicted return',
                },
              },
              x: {
                title: {
                  display: true,
                  text: 'Ticker',
                },
              },
            },
          },
        });
      }

      // Kick off data loading when the page loads
      fetchSignals();
    </script>
  </body>
</html>